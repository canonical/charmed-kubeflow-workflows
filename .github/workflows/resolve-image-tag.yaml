name: Resolve full image tag

on:
  workflow_call:
    inputs:
      rock-reference:
        description: "<rock-name>:<rock-version>"
        required: true
        type: string
      registry:
        description: "Image registry"
        required: false
        default: "docker.io/charmedkubeflow"
        type: string

    outputs:
      full-image-tag:
        description: "Full image tag with registry, rock name, version, and commit"
        value: ${{ jobs.resolve.outputs.full-image-tag }}

jobs:
  resolve:
    runs-on: ubuntu-24.04
    name: Resolve tag ${{ inputs.rock-reference }}
    outputs:
      full-image-tag: ${{ steps.set.outputs.full-image-tag }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Calculate image tag
        id: set
        run: |
          COMMIT_ID=$(git rev-parse --short HEAD)
          IMAGE_TAG="${{ inputs.registry }}/${{ inputs.rock-reference }}-${COMMIT_ID}"
          echo "Resolved image tag: $IMAGE_TAG"
          echo "full-image-tag=$IMAGE_TAG" >> $GITHUB_OUTPUT
