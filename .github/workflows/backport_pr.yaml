name: Backport PR

on:
  workflow_call:
    # We will remove this after the fact
    secrets:
      CHACI_GPG_PRIVATE:
        required: true
      CHACI_GPG_PASSPHRASE:
        required: true
      GH_TOKEN:
        required: true

jobs:
  backport-pr:
    runs-on: ubuntu-24.04
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
      - name: Import and configure the GPG key
        id: import-gpg
        uses: crazy-max/ghaction-import-gpg@e89d40939c28e39f97cf32126055eeae86ba74ec
        with:
          gpg_private_key: ${{ secrets.CHACI_GPG_PRIVATE }}
          passphrase: ${{ secrets.CHACI_GPG_PASSPHRASE }}
          git_config_global: true
          git_user_signingkey: true
          git_commit_gpgsign: true
      - name: Verify GPG Private Key Presence
        env:
          # Load secret into an environment variable first
          GPG_KEY: ${{ secrets.CHACI_GPG_PRIVATE }}
        run: |
          # 1. Check if empty
          if [ -z "$GPG_KEY" ]; then
            echo "❌ Error: CHACI_GPG_PRIVATE is empty!"
            exit 1
          fi

          # 2. Check the length (A valid key is usually > 1000 chars)
          echo "✅ Secret exists. Length: ${#GPG_KEY} characters."

          # 3. Sanity check: Does it look like a GPG key?
          # We grep for the standard header. If found, it prints the header (safe).
          if echo "$GPG_KEY" | grep -q "BEGIN PGP PRIVATE KEY BLOCK"; then
            echo "✅ Format check passed: Found 'BEGIN PGP PRIVATE KEY BLOCK'"
          else
            echo "⚠️ Warning: Secret is set, but does not look like a standard GPG Private Key block."
          fi
      - name: Verify Secret Presence
        env:
          MY_SECRET: ${{ secrets.CHACI_GPG_PASSPHRASE }}
        run: |
          if [ -z "$MY_SECRET" ]; then
            echo "❌ Secret is EMPTY or MISSING"
            exit 1
          else
            echo "✅ Secret is SET. Length: ${#MY_SECRET} characters"
          fi
      - name: Create backport pull requests
        uses: korthout/backport-action@v3
        with:
          copy_assignees: true
          copy_requested_reviewers: true
          github_token: ${{ secrets.GH_TOKEN }}
          experimental: '{"conflict_resolution": "draft_commit_conflicts"}'
          git_committer_name: ${{ steps.import-gpg.outputs.name }}
          git_committer_email: ${{ steps.import-gpg.outputs.email }}
